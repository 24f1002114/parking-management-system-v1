<!DOCTYPE html>
<html lang="en">

<head>
    <title>User Dashboard</title>
    <link rel="stylesheet" href="../static/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>

<body>
    <div id="main">
        <!--Alert Message-->
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-info">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}
        <div id="canvas" class="overflow-auto">
            <!-- Navbar -->
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">Welcome to {{this_user.username}}</a>
                    <div class="collapse navbar-collapse " id="navbarSupportedContent">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('user.user', user_id=this_user.id) }}">Home</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('user.summary') }}">Summary</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('admin.login') }}">Logout</a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="text-center" >
                    <a class="nav-link" href="{{ url_for('user.profile', user_id=this_user.id) }}">Edit_Profile</a>
                </div>
            </nav>
            <!-- Main Content -->
            <div id="content">
                <!-- Showing reservation History of user -->
                <h3 class="headings">Recent Parking History</h3>
                <div id="table" class="border table-container" style="max-height:200px;">
                    <table class="table fixed-header-table">
                        <thead>
                            <tr>
                                <th>Spot ID</th>
                                <th>Location</th>
                                <th>Vehicle No</th>
                                <th>Parking Time</th>
                                <th>Leaving Time</th>
                                <th>Cost</th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in reservation %}
                            {% if r and r.spot %}
                            <tr>
                                <td>{{ r.spot_id }}</td>
                                <td>{{ r.spot.parking_lot.prime_location_name }}</td>
                                <td>{{ r.vehicle_no }}</td>
                                <td>{{ r.parking_timestamp.strftime("%Y-%m-%d %H:%M:%S") }}</td>
                                <td>
                                    {% if r.leaving_timestamp %}
                                    {{ r.leaving_timestamp.strftime("%Y-%m-%d %H:%M:%S") }}
                                    {% else %}
                                    <span class="text-warning">Active</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if r.parking_cost %}
                                    â‚¹{{ '%.2f'|format(r.parking_cost) }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if r.spot.status == 'O' %}
                                    {% if r.leaving_timestamp == None and r.user_id == user_id %}
                                    <a href="{{ url_for('user.release', spot_id=r.spot_id) }}"
                                        class="btn btn-danger">Release</a>
                                    {% elif r.user_id != user_id %}
                                    <span class="text-danger">Not your booking</span>
                                    {% else %}
                                    <span class="btn btn-success disabled">Parked Out</span>
                                    {% endif %}
                                    {% else %}
                                    <span class="btn btn-success disabled">Parked Out</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <!--Serching Parking Locations-->
                <div class="mb-3" style="margin-top: 80px;">
                    <h4>Search Parking Lot by Location</h4>
                    <form class="d-flex" action="/user/{{ this_user.id }}" method="POST">
                        <select name="search" class="form-control me-2" required>
                            <option selected>select</option>
                            {% for location in prime_locations %}
                            <option value="{{ location }}" {% if query==location %}selected{% endif %}>{{ location
                                }}</option>
                            {% endfor %}
                        </select>
                        <input class="btn btn-outline-success" type="submit" value="Search">
                    </form>
                </div>
                <!--Parking Lot At Location-->
                <h3 class="headings">Parking Lot @{{ query }}</h3>
                <div id="table" class="border table-container" style="max-height:200px;">
                    <table class="table fixed-header-table">
                        <thead>
                            <tr>
                                <th>Lot ID</th>
                                <th>Address</th>
                                <th>Availability</th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if parking_lots %}
                            {% for info in parking_lots %}
                            <tr>
                                <th>{{ info.id }}</th>
                                <td>{{ info.address }}</td>
                                <td>{{ info.spots | selectattr('status', 'equalto', 'A') | list | length }}</td>
                                <td class="text-center">
                                    <a href="/book/{{info.id}}  " class="btn btn-primary">Book</a>
                                </td>
                            </tr>
                            {% endfor %}
                            {% elif query %}
                            <tr>
                                <td colspan="4">Please select a location to view <strong>available </strong> spots or
                                    make a <strong>booking</strong>.</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    </div>
</body>

</html>